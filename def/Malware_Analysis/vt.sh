#!/bin/bash 
#
# Description: used to interact with the Virus Total API & database
# Usage:  ./vt.sh <options> <target> 
# --where '-h', '-f','-u' are (hash, file, and URL) respectfully  


# 1. FIRST OBTAIN  VIRUSTOTAL API KEY 
# --CHK KEYRING FILE FOR VT API KEY 

#apikey_extract()
#{
#       egrep 'virustotalAPIKEY' keyring.txt | cut -d '=' -f2
#}

api_chk()
{
        # (!) ADD WHILE LOOP TO ACCT. FOR BLANK VALUE
        # (!) ASK USER IF THEY WANT TO STORE KEY IN A PWD
        if [ -z $APIKEY ] 
        then 
                printf "Please provide your VIRUS TOTAL API KEY: "
                read APIKEY
        fi

        #MAY WAMT TO PROMPT USER BEFORE MOVING FORWARD 
        #echo "Is this your VIRUS TOTAL APIKEY? (Y/N): $APIKEY  "
}


echo "WARNING: To make use of this script you will NEED a VIRUS TOTAL APIKEY provided through a VIRUS ACCOUNT. "
echo "--signup for FREE at https://virustotal.com "
echo " "


# OBTAIN API KEY FOR VIRUS TOTAL DB QUERY
#APIKEY=$(apikey_extract) 
api_chk 

# 2. SCAN CMDLINE OPTS + ARGS &

while getopts 'h:f:u*' opt
do
        case $opt in
                h) #CHECK VIRUS TOTAL HASH-DB
                       HASH="$2"
                       echo "APIKEY: $APIKEY"
                       echo "HASH: $HASH"
                       echo ""

                       curl 'https://www.virustotal.com/vtapi/v2/file/report?apikey=$APIKEY&resource=$HASH&allinfo=false' > vt_hash_scan_result.txt

                ;;

                f) #VIRUSTOTAL FILE UPLOAD
                       FILE=$2
                       if ! [ -f $FILE ]
                       then
                               echo "This is not a file. A file is required to upload to database."
                       fi

                       echo "APIKEY: $APIKEY"
                       echo "FILUPLOAD: $FILE"

                       curl --request POST url 'https:&#x00F;/www.virustotal.com/vtapi/v2/file/scan' --form 'apikey=$APIKEY' --form 'file=$FILE'
                ;;

                u) #VIRUSTOTAL URL SCAN
                       URL=$2
                       echo "APIKEY: $APIKEY"
                       echo "URL: $URL"

                       curl 'https://www.virustotal.com/vtapi/v2/url/report?apikey=$APIKEY&resource=$URL&allinfo=false&scan=1'
                ;;

                *) #EITHER DEFAULT OPTION TRIGGERED
                       #(!) ADD ANOTHER EXIT 
                       echo "Usage: ./vt.sh [option] [argument/target]"
                       exit 2

                ;;
       esac
done       
       